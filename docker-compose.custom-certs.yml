version: '3.8'

services:
  traefik:
    image: traefik:v2.10
    command:
      - "--api.insecure=false"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Custom certificates configuration
      - "--providers.file.directory=/etc/traefik/certs"
      - "--providers.file.watch=true"
      # Let's Encrypt fallback (optional)
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@industrace.internal}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./letsencrypt:/letsencrypt"
      # Mount custom certificates
      - "${CERT_PATH}:/etc/traefik/certs/cert.crt:ro"
      - "${KEY_PATH}:/etc/traefik/certs/key.key:ro"
      - "${CA_PATH}:/etc/traefik/certs/ca.crt:ro"
      # Optional: Certificate chain
      - "${CHAIN_PATH:-/dev/null}:/etc/traefik/certs/chain.crt:ro"
    networks:
      - industrace-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`${TRAEFIK_DOMAIN:-traefik.industrace.internal}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"
    restart: unless-stopped

  db:
    image: postgres:15
    environment:
      POSTGRES_USER: industrace_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: industrace
    volumes:
      - industrace_postgres_data:/var/lib/postgresql/data
    networks:
      - industrace-network
    labels:
      - "traefik.enable=false"
    expose:
      - "5432"
    restart: unless-stopped

  backend:
    build: ./backend
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    environment:
      - DATABASE_URL=postgresql://industrace_user:${DB_PASSWORD}@db:5432/industrace
      - SECRET_KEY=${SECRET_KEY}
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
      - CORS_ORIGINS=https://${DOMAIN},https://${WWW_DOMAIN}
      - ENVIRONMENT=production
      - DEBUG=false
      - SECURE_COOKIES=true
      - SAME_SITE_COOKIES=strict
    depends_on:
      - db
    networks:
      - industrace-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`${DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.backend.priority=100"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.backend-strip.stripprefix.prefixes=/api"
      - "traefik.http.routers.backend.middlewares=backend-strip"
      - "traefik.http.middlewares.backend-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.backend.middlewares=backend-headers"
    restart: unless-stopped

  frontend:
    build: ./frontend
    command: npm run build && npx serve -s dist -l 5173
    volumes:
      - ./uploads:/app/uploads
    environment:
      - VITE_API_URL=https://${DOMAIN}/api
    depends_on:
      - backend
    networks:
      - industrace-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN}`) && !PathPrefix(`/api`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.frontend.priority=10"
      - "traefik.http.services.frontend.loadbalancer.server.port=5173"
      - "traefik.http.middlewares.frontend-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.frontend.middlewares=frontend-headers"
    restart: unless-stopped

volumes:
  industrace_postgres_data:

networks:
  industrace-network:
    driver: bridge
